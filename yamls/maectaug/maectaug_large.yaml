stage_name: stage2
datasets:
  train:
    kind: image_net
    version: imagenet1k
    split: train
    sample_wrappers:
    - kind: multi_view_wrapper
      transforms:
      - - interpolation: bicubic
          kind: kd_random_resized_crop
          scale:
          - 0.08
          - 1.0
          size: 224
        - kind: kd_random_horizontal_flip
        - brightness: 0.4
          contrast: 0.4
          hue: 0.1
          kind: kd_random_color_jitter
          p: 0.8
          saturation: 0.2
        - kind: kd_gaussian_blur_pil
          sigma:
          - 0.1
          - 2.0
        - kind: kd_random_grayscale
          p: 0.2
        - kind: kd_image_net_norm
      - - interpolation: bicubic
          kind: kd_random_resized_crop
          scale:
          - 0.08
          - 1.0
          size: 224
        - kind: kd_random_horizontal_flip
        - brightness: 0.4
          contrast: 0.4
          hue: 0.1
          kind: kd_random_color_jitter
          p: 0.8
          saturation: 0.2
        - kind: kd_random_gaussian_blur_pil
          p: 0.1
          sigma:
          - 0.1
          - 2.0
        - kind: kd_random_grayscale
          p: 0.2
        - kind: kd_random_solarize
          p: 0.2
          threshold: 128
        - kind: kd_image_net_norm
model:
  kind: mae_contheads_vit
  encoder:
    kind: vit.masked_encoder
    patch_size: 16
    embedding_dim: 1024
    depth: 24
    attention_heads: 16
    optim:
      kind: adamw
      lr: 0.0001
      betas:
      - 0.9
      - 0.95
      weight_decay: 0.05
      param_group_modifiers:
      - decay: 0.65
        kind: layerwise_lr_decay_modifier
      schedule:
      - end_percent: 20
        exclude_first: true
        exclude_last: true
        kind: linear_increasing
      - exclude_last: true
        kind: cosine_decreasing
    freezers:
    - kind: vit_block_freezer
      block_idxs:
      - 0
      - 1
      - 2
      - 3
      - 4
      - 5
      - 6
      - 7
      - 8
      - 9
      - 10
      - 11

    initializer:
      checkpoint: last
      kind: previous_run_initializer
      model_name: mae_contheads_vit.encoder
      stage_id: 118qpo63
      stage_name: stage_train_head
  contrastive_heads:
    nnclr:
      kind: contrastive_heads.nnclr_ema_queue_head
      proj_hidden_dim: 2048
      pred_hidden_dim: 4096
      output_dim: 256
      queue_size: 65536
      target_factor: 0.99
      temperature: 0.15
      topk: 10
      optim:
        kind: adamw
        lr: 0.0005
        betas:
        - 0.9
        - 0.95
        weight_decay: 1.0e-05
        schedule:
        - end_percent: 20
          exclude_first: true
          exclude_last: true
          kind: linear_increasing
        - exclude_last: true
          kind: cosine_decreasing
      pooling:
        kind: class_token
      initializer:
        checkpoint: last
        kind: previous_run_initializer
        model_name: mae_contheads_vit.head.nnclr
        stage_id: 118qpo63
        stage_name: stage_train_head

trainer:
  kind: mae_contheads_vit_trainer
  max_epochs: 40
  effective_batch_size: 1024
  precision: bfloat16
  mask_generator:
    kind: random_mask_generator
    mask_ratio: 0.0
  normalize_pixels: true
  log_every_n_epochs: 1
  loggers:
  - kind: group_update_output_logger
    every_n_samples: 65536
    pattern: nn_accuracy
  - kind: group_update_output_logger
    every_n_epochs: 1
    pattern: nn_accuracy
  - kind: checkpoint_logger
    every_n_epochs: 1
  - kind: ema_logger
    every_n_epochs: 1
    model_paths:
    - encoder
    target_factors:
    - 0.9999
